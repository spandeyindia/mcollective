#summary Using Chef with MCollective
#labels migrated

= This wiki has migrated to [http://marionette-collective.org/] = 


= Introduction =

If you're a Chef user you are supported in both facts and classes filters.

*NOTE: This is available from version 0.4*

= Facts =
There is a [http://code.google.com/p/mcollective-plugins/wiki/FactsOpsCodeOhai community plugin to enable Ohai] as a fact source.

Using this plugin Ohai facts will be converted from:

{{{
  "languages": {
    "java": {
      "runtime": {
        "name": "OpenJDK  Runtime Environment",
        "build": "1.6.0-b09"
      },
      "version": "1.6.0"
    },
}}}

to: 

{{{
 "languages.java.version"=>"1.6.0",
 "languages.java.runtime.name"=>"OpenJDK  Runtime Environment",
 "languages.java.runtime.build"=>"1.6.0-b09",
}}}

So you can use the flattened versions of the information provided by Ohai in filters, reports etc.

{{{
$ mc-find-hosts --with-fact languages.java.version=1.6.0
}}}

= Class Filters =
Chef does not provide a list of roles and recipes that has been applied to a node, to use with MCollective you need to create such a list.

It's very easy with Chef to do this in a simple cookbook.  Put the following code in a cookbook and arrange for it to run *last* on your node.

This will create a list of all roles and recipes in _/var/tmp/chefnode.txt_ on each node for us to use:

{{{
ruby_block "store node data locally" do
  block do
    state = File.open("/var/tmp/chefnode.txt", "w")

    node.run_state[:seen_recipes].keys.each do |recipe|
        state.puts("recipe.#{recipe}")
    end

    node.run_list.roles.each do |role|
        state.puts("role.#{role}")
    end

    state.close
  end
end
}}}


You should configure MCollective to use this file by putting the following in your _server.cfg_

{{{
classesfile = /var/tmp/chefnode.txt
}}}

You can now use your roles and recipe lists in filters:

{{{
$ mc-find-hosts --with-class role.webserver --with-class /apache/
}}}
